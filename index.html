<!DOCTYPE html>
<html lang="vi">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DNY Sport ‚Äî G·ª£i √Ω size ƒêa M√¥n</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>


  <style>
.required {
    color: #ff4b4b;
    margin-left: 2px;
}
.popup-close {
    font-family: 'Be Vietnam Pro', sans-serif !important;
}

.team-box {
    position: relative;
}


.popup-info-btn {
    position: absolute;
    top: 6px;       
    right: 6px;     
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 5;     
}
.hidden {
  display: none !important;
}


.info-circle {
    width: 22px;
    height: 22px;
    border: 2px solid #ff4b4b;
    border-radius: 50%;
    color: #ff4b4b;
    font-weight: 900;
    font-size: 14px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: 0.2s ease;
}


.popup-info-btn:hover .info-circle {
    background: #ff4b4b;
    color: #fff;
}



.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9990;
}


.popup-box {
  background: #ffffff;
  width: 92%;
  max-width: 430px;
  border-radius: 18px;
  padding: 22px 26px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.18);
  animation: fadeUp .25s ease;
  font-family: 'Be Vietnam Pro', sans-serif;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.popup-title {
  font-size: 22px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 16px;
  color: #0b3954;
}


.popup-section {
  display: flex;
  gap: 12px;
  margin-bottom: 14px;
}

.popup-section .icon {
  font-size: 32px;
  line-height: 32px;
}

.popup-section h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  color: #06324b;
}

.popup-section p, .popup-section ul {
  margin: 4px 0 0;
  font-size: 14px;
  color: #0f172a;
  line-height: 1.45;
}

.popup-section ul {
  padding-left: 18px;
}


.popup-close {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  font-size: 15px;
  font-weight: 900;
  border-radius: 12px;
  border: none;
  background: #1594c8;
  color: #fff;
  cursor: pointer;
}

.popup-close:hover {
  background: #0b6c9b;
}


.guide-btn {
  background: #eef5fb;
  color: #06324b;
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid #d7e7f2;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
}
.guide-btn:hover {
  background: #dceaf5;
}

.btn i{
  width:18px;
  height:18px;
  margin-right:6px;
}

.team-bottom-buttons{
  display:flex;
  gap:15px;
  margin-top:20px;
}

.team-bottom-buttons .btn.small{
  padding:10px 18px;
  font-size:14px;
}

.team-bottom-buttons .danger{
  background:#ff5b5b;
  color:white;
}

    .illu-wrap{
      text-align:center;
      margin-bottom:14px;
    }
    .illu-wrap img{
      max-width:300px;
      width:100%;
      height:auto;
    }

    :root{
      --bg-page:#f3f7fc;
      --pri:#1594c8;
      --pri-dark:#0b6c9b;
      --pill-bg:#f5fbff;
      --pill-border:#cbd5f5;
      --ink:#0f172a;
    }
    *{box-sizing:border-box}
body{
  font-family: 'Be Vietnam Pro', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  margin:0;
  background:var(--bg-page);
  color:var(--ink);
}

    main{
      max-width:1700px;
      margin:26px auto;
      padding:0 16px 26px;
    }
    .shell{
      background:#fff;
      border-radius:24px;
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:22px 22px 22px;
      display:grid;
      grid-template-columns:1.1fr 1.05fr .9fr;
      gap:18px;
    }
    @media(max-width:960px){
      .shell{grid-template-columns:1fr}
    }
    .card-left{
      border-right:1px solid #e5edf7;
      padding-right:18px;
    }
    .card-middle{
      padding:0 18px;
      border-right:1px solid #e5edf7;
    }
    @media(max-width:960px){
      .card-left,
      .card-middle{
        border-right:none;
        padding-right:0;
        padding-left:0;
      }
    }
    .card-right{}

    label{font-weight:650;font-size:14px;display:block;margin:10px 0 6px}
    input,select{
      width:100%;
      padding:12px 14px;
      border:1px solid #d7e7f2;
      border-radius:12px;
      font-size:15px;
      outline:none;
    }
    input::placeholder{color:#cbd5e1}
    input:focus,select:focus{
      border-color:var(--pri);
      box-shadow:0 0 0 3px rgba(21,148,200,.14);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:11px 20px;
  border-radius:12px;
  border:0;
  cursor:pointer;
  font-family: 'Be Vietnam Pro', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  font-weight:900; 
  font-size:15px;
}

    .btn-primary{
      background:var(--pri);
      color:#fff;
    }
    .btn-primary:hover{background:var(--pri-dark);}
    .btn-ghost{
      background:#eef5fb;
      color:#06324b;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:#ecfeff;
      color:#06324b;
      font-weight:800;
      border:1px solid #c7f2ff;
    }
    .result{
      border:2px dashed #cfe8fb;
      border-radius:16px;
      padding:14px 14px 12px;
      background:#f4fbff;
      margin-top:14px;
    }
    .size-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
      height:40px;
      border-radius:12px;
      background:#0b1120;
      color:#fff;
      font-weight:900;
      font-size:18px;
      padding:0 10px;
    }
    .hint{font-size:13px;color:#0b3954;margin-top:6px}
    .error{color:#b91c1c;font-weight:800;margin-top:8px}
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:14px;
    }
    th,td{
      text-align:center;
      padding:8px 6px;
      border-bottom:1px solid #eef2f7;
    }
    th{
      background:#f5fbff;
      font-weight:700;
    }
    .subtitle{
      color:#0b3954;
      font-weight:800;
      margin:4px 0 4px;
    }
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .note{
      background:#fff8e1;
      border:1px solid #fde68a;
      color:#8a6d00;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      margin-top:10px;
    }
    tr.pick{background:#e7f5ff !important;}
    tr.heightRow{background:#fef3c7 !important;}
    .hidden{display:none}
    .score{font-size:12px;color:#475569;margin-left:6px}
    .suggestion-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media(max-width:767px){.suggestion-grid{grid-template-columns:1fr}}
    .sugg-card{
      background:#fff;
      border-radius:10px;
      border:1px solid #dbeafe;
      padding:10px 12px;
    }
    .sugg-title{
      font-size:13px;
      font-weight:800;
      color:#1e293b;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .sugg-title span.label{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .sugg-body{font-size:13px;color:#0f172a}
    .cut-main{font-weight:900;font-size:18px;color:#dc2626;margin-top:6px}
    .cut-sub{font-size:12px;color:#475569;margin-top:2px}
    .cut-cell{font-weight:800;color:#dc2626}

    .mode-tabs{
      display:flex;
      gap:10px;
      margin-bottom:12px;
    }
    .mode-pill{
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 10px;
      border-radius:999px;
      border:2px solid var(--pill-border);
      background:var(--pill-bg);
      font-size:13px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.03em;
      cursor:pointer;
      color:#0f172a;
    }
    .mode-pill input{display:none;}
    .mode-pill.active{
      background:var(--pri);
      border-color:var(--pri);
      color:#fff;
    }
    .mode-pill span{pointer-events:none;}

    .team-box{
      border-radius:16px;
      border:1px dashed #d4e4f7;
      padding:10px 12px 6px;
      margin-top:14px;
      background:#f7fbff;
    }
    .team-title{font-weight:800;font-size:14px;margin-bottom:4px;color:#0b3954}
    .team-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .team-table-wrap{
      max-height:520px; 
      overflow:auto;
      margin-top:6px
    }
    .team-table-wrap table{font-size:13px}

    .btn-del{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:#475569;
    }
    .btn-del:hover{
      background:#fee2e2;
      border-color:#fecaca;
      color:#b91c1c;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<div id="excelGuidePopup" class="popup-overlay">
  <div class="popup-box">
    
    <h2 class="popup-title">üìò H∆∞·ªõng d·∫´n nh·∫≠p Excel</h2>

    <div class="popup-section">
      <div class="icon">üì•</div>
      <div>
        <h3>1. T·∫£i Excel m·∫´u</h3>
        <p>
          Nh·∫•n <b>‚ÄúT·∫£i Excel m·∫´u‚Äù</b> ƒë·ªÉ l·∫•y file chu·∫©n.  
          Trong file, b·∫°n ch·ªâ c·∫ßn ƒëi·ªÅn:<br>
        <ul>
          <li>T√™n & S·ªë √°o, ƒê·ªëi t∆∞·ª£ng, S·ªë ƒëo t∆∞∆°ng ·ª©ng  
          (D√†i √°o ‚Äì Ng·ª±c ‚Äì Tay ho·∫∑c Cao ‚Äì N·∫∑ng)</li>
        </ul>
        </p>
      </div>
    </div>

    <div class="popup-section">
      <div class="icon">üì§</div>
      <div>
        <h3>2. Nh·∫≠p t·ª´ Excel</h3>
        <p>
          Nh·∫•n <b>‚ÄúNh·∫≠p t·ª´ Excel‚Äù</b> ‚Üí ch·ªçn file v·ª´a ƒëi·ªÅn.<br>

          H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông:<br>
        </p>
        <ul>
         <li> ƒê·ªçc d·ªØ li·ªáu  ‚Üí  G·ª£i √Ω size  ‚Üí  Th√™m v√†o danh s√°ch ƒë·ªôi</li>
        </ul>
      </div>
    </div>

    <div class="popup-section">
      <div class="icon">üíõ</div>
      <div>
        <h3>L∆∞u √Ω nh·ªè</h3>
        <ul>
          <li>Gi·ªØ nguy√™n t√™n c√°c c·ªôt trong file m·∫´u.</li>
          <li>ƒêi·ªÅn ƒë·ªß th√¥ng tin quan tr·ªçng.</li>
          <li>Ch·ªçn ƒë√∫ng ch·∫ø ƒë·ªô: <b>Ch·ªçn theo th√¥ng s·ªë √°o</b> ho·∫∑c <b>Ch·ªçn theo chi·ªÅu cao & C√¢n n·∫∑ng.</b></li>
        </ul>
      </div>
    </div>

    <button class="popup-close" onclick="closeGuide()">ƒê√É HI·ªÇU</button>
  </div>
</div>
<div id="shareGuidePopup" class="popup-overlay" style="display:none;">
  <div class="popup-box">
    <h2 class="popup-title">‚ö†Ô∏è Kh√¥ng th·ªÉ chia s·∫ª file</h2>
    <p style="font-size:15px; line-height:1.5; margin-top:8px;">
      Thi·∫øt b·ªã ho·∫∑c tr√¨nh duy·ªát c·ªßa b·∫°n hi·ªán kh√¥ng h·ªó tr·ª£<br>
      <b>chia s·∫ª file Excel tr·ª±c ti·∫øp.</b><br><br>
      B·∫°n c√≥ th·ªÉ:
      <br>‚Ä¢ B·∫•m <b>T·∫£i v·ªÅ</b> ƒë·ªÉ l∆∞u file Excel
      <br>‚Ä¢ Sau ƒë√≥ g·ª≠i file th·ªß c√¥ng qua Zalo, Messenger ho·∫∑c Email<br><br>
      <i>G·ª£i √Ω: Ch·ª©c nƒÉng chia s·∫ª file th∆∞·ªùng ho·∫°t ƒë·ªông t·ªët tr√™n thi·∫øt b·ªã IOS (iPhone).</i>
    </p>

    <button class="popup-close" onclick="closeShareGuide()">ƒê√£ hi·ªÉu ‚úî</button>
  </div>
</div>

<main>
  <div class="shell">
    <section class="card-left">
      <div class="mode-tabs">
        <label class="mode-pill active" id="pillMeasure">
          <input type="radio" name="mode" value="measure" checked onchange="switchMode()">
<div style="text-align:center;">
    <span>Ch·ªçn theo th√¥ng s·ªë √°o</span>
</div>

        </label>
        <label class="mode-pill" id="pillBody">
          <input type="radio" name="mode" value="body" onchange="switchMode()">
          <div style="text-align:center;">
            Ch·ªçn theo chi·ªÅu cao<br>
            &amp; c√¢n n·∫∑ng
          </div>
        </label>
      </div>

      <div class="row">
        <div>
          <label for="sport">M√¥n th·ªÉ thao</label>
          <select id="sport" onchange="handleSportChange()">
            <option value="football" selected>B√≥ng ƒë√° (Ti√™u chu·∫©n)</option>
            <option value="baseball">B√≥ng ch√†y (Form r·ªông/Unisex)</option>
            </select>
        </div>
        <div>
          <label for="gender">ƒê·ªëi t∆∞·ª£ng</label>
          <select id="gender" onchange="toggleTables()">
            <option value="male" selected>Nam</option>
            <option value="female">N·ªØ</option>
            <option value="kids">Tr·∫ª em</option>
          </select>
        </div>
      </div>

      <div id="measureBlock" style="margin-top:10px">
        <div class="row">
          <div>
            <label for="len">D√†i √°o (cm) <span class="required">*</span></label>
            <input id="len" inputmode="decimal" placeholder="VD: 70">
          </div>
          <div>
            <label for="chest">Ngang ng·ª±c √°o (cm) <span class="required">*</span></label>
            <input id="chest" inputmode="decimal" placeholder="VD: 52">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="sleeve">D√†i tay (cm)</label>
            <input id="sleeve" inputmode="decimal" placeholder="VD: 22">
          </div>
        </div>
      </div>

      <div id="bodyBlock" class="hidden" style="margin-top:10px">
<div class="row">
  <div>
    <label for="height">Chi·ªÅu cao (cm) <span class="required">*</span></label>
    <input id="height" inputmode="decimal" placeholder="VD: 172">
  </div>
  <div>
    <label for="weight">C√¢n n·∫∑ng (kg) <span class="required">*</span></label>
    <input id="weight" inputmode="decimal" placeholder="VD: 68">
  </div>
</div>

        <div class="hint">
          H·ªá th·ªëng s·∫Ω <b>∆∞u ti√™n C√¢n n·∫∑ng</b> ƒë·ªÉ ch·ªçn size √°o, sau ƒë√≥ ƒë·ªëi chi·∫øu chi·ªÅu cao ƒë·ªÉ g·ª£i √Ω c·∫Øt/tƒÉng lai.
        </div>
      </div>

      <div class="row" style="margin-top:10px">
  <div>
    <label for="playerName">T√™n c·∫ßu th·ªß</label>
    <input id="playerName" placeholder="VD: Nguy·ªÖn VƒÉn A">
  </div>

  <div>
    <label for="playerNumber">S·ªë √°o (tu·ª≥ ch·ªçn)</label>
    <input id="playerNumber" inputmode="numeric" placeholder="VD: 10">
  </div>
</div>


      <div class="flex" style="margin-top:14px">
        <button class="btn btn-primary" type="button" onclick="handleSuggest()">
          G·ª¢I √ù SIZE
        </button>
        <button class="btn btn-ghost" type="button" onclick="clearAll()">Xo√°</button>
        <span id="adultSizes" class="pill">XS ‚Ä¢ S ‚Ä¢ M ‚Ä¢ L ‚Ä¢ XL ‚Ä¢ XXL ‚Ä¢ 3XL ‚Ä¢ 4XL...</span>
        <span id="kidSizes" class="pill hidden">0 ‚Ä¢ 1 ‚Ä¢ 3 ‚Ä¢ 5 ‚Ä¢ 7 ‚Ä¢ 9 ‚Ä¢ 11 ‚Ä¢ 13</span>
      </div>

      <div id="kidNote" class="note hidden">
        Tr·∫ª em: c√≥ th·ªÉ d√πng c·∫£ 2 c√°ch. B·∫£ng size tham chi·∫øu ch·ªß y·∫øu theo <b>c√¢n n·∫∑ng &amp; ƒë·ªô tu·ªïi</b>.
      </div>
      <div id="unisexNote" class="note hidden">
        <b>L∆∞u √Ω:</b> B√≥ng ch√†y s·ª≠ d·ª•ng form Unisex (Nam/N·ªØ chung b·∫£ng size).
      </div>

      <div id="err" class="error" style="display:none"></div>
      <div id="result" class="result" style="display:none"></div>
    </section>

    <aside class="card-middle">
      <div class="illu-wrap">
        <img id="illuImg" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png" alt="Minh h·ªça ƒëo √°o">
      </div>

      <div id="maleTblWrap">
        <style>
          .subtitle {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
          }
        </style>

        <div id="tblTitleMale" class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê NAM</div>
        <table aria-label="B·∫£ng size Nam">
          <thead>
            <tr>
              <th>Size</th>
              <th>C√¢n n·∫∑ng (kg)</th>
              <th>Chi·ªÅu cao (cm)</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyMale"></tbody>
        </table>
      </div>

      <div id="femaleTblWrap" class="hidden">
        <div class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê N·ªÆ</div>
        <table aria-label="B·∫£ng size N·ªØ">
          <thead>
            <tr>
              <th>Size</th>
              <th>Kg tham kh·∫£o</th>
              <th>Chi·ªÅu cao (cm)</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>Ngang eo</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyFemale"></tbody>
        </table>
      </div>

      <div id="kidTblWrap" class="hidden">
        <div class="subtitle" style="font-size:20px;">B·∫¢NG TH√îNG S·ªê TR·∫∫ EM</div>
        <table aria-label="B·∫£ng size Tr·∫ª em">
          <thead>
            <tr>
              <th>Size</th>
              <th>Kg tham kh·∫£o</th>
              <th>Tu·ªïi</th>
              <th>D√†i √°o</th>
              <th>Ngang ng·ª±c</th>
              <th>D√†i tay</th>
            </tr>
          </thead>
          <tbody id="tableBodyKid"></tbody>
        </table>
      </div>

      <p class="hint" style="margin-top:6px">
        D√≤ng ƒë∆∞·ª£c ch·ªçn s·∫Ω ƒë∆∞·ª£c highlight trong b·∫£ng. (V√†ng: theo chi·ªÅu cao, Xanh: theo Size ch·ªët).
      </p>
    </aside>

    <aside class="card-right">
      <div class="team-box">
<button class="popup-info-btn" onclick="openGuide()">
  <span class="info-circle">!</span>
</button>
<div class="team-title" style="font-size:20px;">DANH S√ÅCH ƒê·ªòI</div>
        <div class="hint">
          M·ªói l·∫ßn b·∫•m <b>‚ÄúG·ª£i √Ω size‚Äù</b>, h·ªá th·ªëng s·∫Ω t·ª± th√™m 1 d√≤ng v√†o b·∫£ng.
        </div>
        <div class="team-actions">
          <button class="btn btn-ghost" type="button" onclick="downloadExcelTemplate()">T·∫£i Excel m·∫´u <i data-lucide="file-down" style="width:20px; height:20px;"></i></button>
          <button class="btn btn-ghost" type="button" onclick="document.getElementById('importExcel').click()">Nh·∫≠p t·ª´ Excel <i data-lucide="file-up" style="width:20px; height:20px;"></i></button>
          <input
            type="file"
            id="importExcel"
            accept=".xlsx,.xls"
            style="display:none"
            onchange="handleImportExcel(event)">
        </div>

        <div class="team-table-wrap">
          <table>
            <thead id="teamHead"></thead>
            <tbody id="teamTableBody"></tbody>
          </table>
        </div>  <div class="team-bottom-buttons">
  <button class="btn small danger" onclick="clearTeam()">X√≥a danh s√°ch ƒë·ªôi</button>

  <button class="btn small" onclick="downloadCSV()">
    T·∫£i v·ªÅ <i data-lucide="download" style="width:20px; height:20px;"></i>
  </button>

<button id="shareButton" class="btn small hidden" onclick="shareExcel()">
  Chia s·∫ª <i data-lucide="share-2" style="width:20px; height:20px;"></i>
</button>


</div>


      </div>
    </aside>
  </div>
</main>

<script>

  // ================= C·∫§U H√åNH H√åNH ·∫¢NH =================
  // B·∫°n thay th·∫ø link ·∫£nh b√≥ng ch√†y v√†o b√™n d∆∞·ªõi nh√©
  const IMG_MAP = {
      football: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png",
      baseball: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgOVlza5Gb9QHNpItToKxqrQi6PgJ736i7ysHmmxXxX0sJC2M1YkiCKPuG_nySLYzCKq_FtNlgoDxPyegXTHqTBDdBudeff-QQiAnr62PLmzpc4Pizy8gWt4pgXIBShNqyApgo-lalLh2co2Uqjc6ReZO2pJyMSQevfWOdz3sVAPhD5J3NEi46Zp6rvfBE/s16000/MINH%20HOA.png" // <--- THAY LINK ·∫¢NH B√ìNG CH√ÄY V√ÄO ƒê√ÇY
  };
  
  // ================= D·ªÆ LI·ªÜU G·ªêC (B√ìNG ƒê√Å / TI√äU CHU·∫®N) =================
  const SOCCER_MALE = [
    {code:"XS",  w:[0,50],   h:[0,145],   len:59,   chest:43.5, sleeve:22},
    {code:"S",   w:[50,55],  h:[145,155], len:62.5, chest:45.5, sleeve:22.5},
    {code:"M",   w:[55,60],  h:[155,160], len:66,   chest:47.5, sleeve:23},
    {code:"L",   w:[60,65],  h:[155,165], len:69,   chest:49.5, sleeve:23.5},
    {code:"XL",  w:[65,70],  h:[160,170], len:72,   chest:51.5, sleeve:24},
    {code:"2XL", w:[70,75],  h:[160,175], len:74,   chest:53.5, sleeve:24.5}, 
    {code:"3XL", w:[75,80],  h:[165,180], len:75.5, chest:55.5, sleeve:25},
    {code:"4XL", w:[80,85],  h:[165,185], len:77,   chest:57.5, sleeve:25.5},
    {code:"5XL", w:[85,90],  h:[165,190], len:78,   chest:59.5, sleeve:25.5},
    {code:"6XL", w:[90,95],  h:[165,195], len:79,   chest:61.5, sleeve:25.5},
    {code:"7XL", w:[95,100], h:[165,200], len:80,   chest:63.5, sleeve:25.5},
    {code:"8XL", w:[100,130],h:[165,210], len:81,   chest:65.5, sleeve:25.5},
  ];

  // ================= D·ªÆ LI·ªÜU N·ªÆ (ƒê√É C·∫¨P NH·∫¨T THEO ·∫¢NH M·ªöI) =================
  const SOCCER_FEMALE = [
    {code:"XS", w:[39,43], h:[149,153], len:52, chest:42, waist:39, sleeve:15},
    {code:"S",  w:[43,46], h:[149,155], len:55.5, chest:44, waist:41, sleeve:16},
    {code:"M",  w:[46,53], h:[149,159], len:59, chest:46, waist:43, sleeve:17},
    {code:"L",  w:[53,57], h:[155,162], len:62, chest:48, waist:45, sleeve:18},
    {code:"XL", w:[57,63], h:[155,170], len:65, chest:50, waist:47, sleeve:19},
    {code:"XXL",w:[63,67], h:[162,173], len:68, chest:52, waist:49, sleeve:20},
    {code:"3XL",w:[67,73], h:[162,177], len:71, chest:54, waist:51, sleeve:21},
    {code:"4XL",w:[73,77], h:[162,180], len:74, chest:56, waist:53, sleeve:22},
    // Gi·ªØ l·∫°i 5XL, 6XL l√†m d·ª± ph√≤ng cho size l·ªõn h∆°n
    {code:"5XL",w:[77,85], h:[162,185], len:77, chest:58, waist:55, sleeve:23},
    {code:"6XL",w:[85,100],h:[162,190], len:80, chest:60, waist:57, sleeve:24},
  ];

  // ================= D·ªÆ LI·ªÜU B√ìNG CH√ÄY (M·ªöI) =================
  const BASEBALL_UNISEX = [
    {code:"S",   w:[50,55],  h:[145,155], len:68, chest:53.5, sleeve:24},
    {code:"M",   w:[55,60],  h:[155,160], len:71, chest:55.5, sleeve:25},
    {code:"L",   w:[60,65],  h:[155,165], len:74, chest:57.5, sleeve:26},
    {code:"XL",  w:[65,70],  h:[160,170], len:77, chest:59.5, sleeve:27},
    {code:"2XL", w:[70,75],  h:[160,175], len:80, chest:61.5, sleeve:27}, 
    {code:"3XL", w:[75,80],  h:[165,180], len:83, chest:63.5, sleeve:28},
    {code:"4XL", w:[80,130], h:[165,210], len:86, chest:65.5, sleeve:29}, 
  ];

  const KIDS=[
    {code:"0", w:[0,10],   age:"1",      len:39.5, chest:29, sleeve:11},
    {code:"1", w:[10,15],  age:"1‚Äì2",    len:42,   chest:31, sleeve:12},
    {code:"3", w:[15,20],  age:"2‚Äì3",    len:44.5, chest:33, sleeve:13},
    {code:"5", w:[20,25],  age:"4‚Äì5",    len:47.5, chest:35, sleeve:14},
    {code:"7", w:[25,30],  age:"6‚Äì7",    len:50.5, chest:37, sleeve:15},
    {code:"9", w:[30,35],  age:"8‚Äì9",    len:53.5, chest:39, sleeve:16},
    {code:"11",w:[35,40],  age:"10‚Äì11",  len:56.5, chest:41, sleeve:17},
    {code:"13",w:[40,45],  age:"Tr√™n 11",len:58.5, chest:43, sleeve:18},
  ];

  // C·∫§U TR√öC D·ªÆ LI·ªÜU T·ªîNG H·ª¢P
  // C√°c m√¥n ch∆∞a c√≥ data ri√™ng s·∫Ω d√πng chung b·∫£ng Football (Ti√™u chu·∫©n)
  const DATA = {
      football:   { male: SOCCER_MALE, female: SOCCER_FEMALE, kids: KIDS },
      baseball:   { male: BASEBALL_UNISEX, female: BASEBALL_UNISEX, kids: KIDS }, // Baseball l√† unisex
      volleyball: { male: SOCCER_MALE, female: SOCCER_FEMALE, kids: KIDS },
      basketball: { male: SOCCER_MALE, female: SOCCER_FEMALE, kids: KIDS },
      running:    { male: SOCCER_MALE, female: SOCCER_FEMALE, kids: KIDS },
      badminton:  { male: SOCCER_MALE, female: SOCCER_FEMALE, kids: KIDS }
  };

  const $ = id => document.getElementById(id);

  function getCurrentData() {
      const sport = $("sport").value;
      const gender = $("gender").value;
      
      // N·∫øu kh√¥ng t√¨m th·∫•y m√¥n, tr·∫£ v·ªÅ b√≥ng ƒë√° m·∫∑c ƒë·ªãnh
      const sportData = DATA[sport] || DATA['football'];
      
      if (gender === 'kids') return sportData.kids;
      if (gender === 'female') return sportData.female;
      return sportData.male;
  }
  
  function renderMale(){
    const sport = $("sport").value;
    const tableData = DATA[sport] ? DATA[sport].male : SOCCER_MALE;
    const isBaseball = sport === 'baseball';

    $("tableBodyMale").innerHTML = tableData.map(r=>{
      let wStr = `${r.w[0]}‚Äì${r.w[1]}`;
      let hStr = `${r.h[0]}‚Äì${r.h[1]}`;

      // Logic hi·ªÉn th·ªã gi·ªëng ·∫£nh g·ªëc
      if(r.code === "XS") { 
          wStr = "< 50"; 
          hStr = "< 145"; 
      }
      else if(r.code === "4XL" && isBaseball) { wStr = "> 80"; hStr = "> 165"; }
      else if(r.code === "5XL") { wStr = "> 85"; hStr = ""; }
      else if(r.code === "6XL") { wStr = "> 90"; hStr = ""; }
      else if(r.code === "7XL") { wStr = "> 95"; hStr = ""; }
      else if(r.code === "8XL") { wStr = "> 100"; hStr = ""; }

      return `<tr>
        <td><b>${r.code}</b></td>
        <td>${wStr}</td>
        <td>${hStr}</td>
        <td>${r.len}</td>
        <td>${r.chest}</td>
        <td>${r.sleeve}</td>
      </tr>`;
    }).join("");
  }

  function renderFemale(){
    const sport = $("sport").value;
    const tableData = DATA[sport] ? DATA[sport].female : SOCCER_FEMALE;
    
    // N·∫øu l√† Baseball (Unisex), c·∫•u tr√∫c b·∫£ng N·ªØ s·∫Ω gi·ªëng b·∫£ng Nam (kh√¥ng c√≥ eo)
    // Nh∆∞ng UI v·∫´n c·∫ßn render ƒë·ªÉ tr√°nh l·ªói, ta s·∫Ω render ki·ªÉu ƒë∆°n gi·∫£n
    if(sport === 'baseball') {
        $("tableBodyFemale").innerHTML = tableData.map(r=>`
          <tr>
            <td><b>${r.code}</b></td>
            <td>${r.w[0]}‚Äì${r.w[1]}</td>
            <td>${r.h[0]}‚Äì${r.h[1]}</td>
            <td>${r.len}</td>
            <td>${r.chest}</td>
            <td>‚Äî</td>
            <td>${r.sleeve}</td>
          </tr>`).join("");
    } else {
        $("tableBodyFemale").innerHTML = tableData.map(r=>`
          <tr>
            <td><b>${r.code}</b></td>
            <td>${r.w[0]}‚Äì${r.w[1]}</td>
            <td>${r.h[0]}‚Äì${r.h[1]}</td>
            <td>${r.len}</td>
            <td>${r.chest}</td>
            <td>${r.waist}</td>
            <td>${r.sleeve}</td>
          </tr>`).join("");
    }
  }
  function renderKids(){
    // Kids th∆∞·ªùng d√πng chung
    const sport = $("sport").value;
    const tableData = DATA[sport] ? DATA[sport].kids : KIDS;

    $("tableBodyKid").innerHTML = tableData.map(r=>{
      let wStr = `${r.w[0]}‚Äì${r.w[1]}`;
      if(r.code === "0") wStr = "< 10"; // Custom display for Size 0
      return `
      <tr>
        <td><b>${r.code}</b></td>
        <td>${wStr}</td>
        <td>${r.age}</td>
        <td>${r.len}</td>
        <td>${r.chest}</td>
        <td>${r.sleeve}</td>
      </tr>`
    }).join("");
  }
  
  function handleSportChange() {
      const sport = $("sport").value;
      const gender = $("gender").value;
      const maleTitle = $("tblTitleMale");
      const unisexNote = $("unisexNote");
      const illu = $("illuImg");
      
      // === LOGIC M·ªöI: ƒê·ªîI H√åNH MINH H·ªåA ===
      if(IMG_MAP[sport]) {
          illu.src = IMG_MAP[sport];
      } else {
          illu.src = IMG_MAP['football']; // M·∫∑c ƒë·ªãnh
      }

      // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ b·∫£ng
      if (sport === 'baseball') {
          maleTitle.textContent = "B·∫¢NG TH√îNG S·ªê UNISEX (B√ìNG CH√ÄY)";
          unisexNote.classList.remove("hidden");
      } else {
          maleTitle.textContent = "B·∫¢NG TH√îNG S·ªê NAM";
          unisexNote.classList.add("hidden");
      }

      // N·∫øu ƒëang ch·ªçn N·ªØ m√† chuy·ªÉn sang Baseball -> T·ª± ƒë·ªông chuy·ªÉn view v·ªÅ b·∫£ng Nam (Unisex) ƒë·ªÉ d·ªÖ nh√¨n
      if (sport === 'baseball' && gender === 'female') {
          // V·∫´n gi·ªØ value gender l√† female ƒë·ªÉ logic g·ª£i √Ω ho·∫°t ƒë·ªông, nh∆∞ng hi·ªÉn th·ªã b·∫£ng Unisex
          $("maleTblWrap").classList.remove("hidden");
          $("femaleTblWrap").classList.add("hidden");
      } else {
          toggleTables(); // Reset view b√¨nh th∆∞·ªùng
      }

      // Render l·∫°i d·ªØ li·ªáu b·∫£ng
      renderMale();
      renderFemale();
      renderKids();
      
      // X√≥a k·∫øt qu·∫£ c≈©
      clearAll();
  }

  // Kh·ªüi t·∫°o
  renderMale(); renderFemale(); renderKids();

  
function parseNum(x){
  if (x == null) return NaN;
  x = String(x)
        .replace(/[^\d,\.\-]/g, "")
        .replace(",", ".")
        .trim();
  if (x === "") return NaN;   
  return Number(x);
}

  function toggleTables(){
    const g = $("gender").value;
    const sport = $("sport").value;
    
    // Logic ƒë·∫∑c bi·ªát cho b√≥ng ch√†y (Unisex)
    if (sport === 'baseball') {
        if (g === 'kids') {
             $("maleTblWrap").classList.add("hidden");
             $("femaleTblWrap").classList.add("hidden");
             $("kidTblWrap").classList.remove("hidden");
             $("kidNote").classList.remove("hidden");
        } else {
             // Nam hay N·ªØ b√≥ng ch√†y ƒë·ªÅu hi·ªán b·∫£ng Male (Unisex)
             $("maleTblWrap").classList.remove("hidden");
             $("femaleTblWrap").classList.add("hidden");
             $("kidTblWrap").classList.add("hidden");
             $("kidNote").classList.add("hidden");
        }
    } else {
        // C√°c m√¥n kh√°c ph√¢n chia b√¨nh th∆∞·ªùng
        $("maleTblWrap").classList.toggle("hidden", g!=="male");
        $("femaleTblWrap").classList.toggle("hidden", g!=="female");
        $("kidTblWrap").classList.toggle("hidden", g!=="kids");
        $("kidNote").classList.toggle("hidden", g!=="kids");
    }

    $("adultSizes").classList.toggle("hidden", g==="kids");
    $("kidSizes").classList.toggle("hidden", g!=="kids");

    // ƒê·∫£m b·∫£o ·∫£nh ƒë√∫ng khi toggle b·∫£ng
    const illu = $("illuImg");
    if(IMG_MAP[sport]) illu.src = IMG_MAP[sport];

    clearAll();
  }
  function clearHighlight(){
    document.querySelectorAll("tbody tr").forEach(tr=>tr.classList.remove("pick","heightRow"));
  }

  function switchMode(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    $("measureBlock").classList.toggle("hidden", mode!=="measure");
    $("bodyBlock").classList.toggle("hidden", mode!=="body");
    $("pillMeasure").classList.toggle("active", mode==="measure");
    $("pillBody").classList.toggle("active", mode==="body");
    $("err").style.display="none";
    $("result").style.display="none";
    renderTeamTable();
  }

  
  function calcSuggestions(len, chest, sleeve, table){
    let bestOverall={idx:-1,score:Infinity};
    let bestChest={idx:-1,score:Infinity};

    table.forEach((s,i)=>{
      let chestScore = (!Number.isNaN(chest) && typeof s.chest==="number")
        ? Math.pow(chest - s.chest,2) : NaN;
      let lenScore   = (!Number.isNaN(len) && typeof s.len==="number")
        ? Math.pow(len - s.len,2) : NaN;
      let sleeveScore= (!Number.isNaN(sleeve) && typeof s.sleeve==="number")
        ? Math.pow(sleeve - s.sleeve,2) : NaN;

      let scoreOverall=0, hasAny=false;
      if(!Number.isNaN(chestScore)){scoreOverall+=1.0*chestScore; hasAny=true;}
      if(!Number.isNaN(lenScore)){scoreOverall+=1.0*lenScore; hasAny=true;}
      if(!Number.isNaN(sleeveScore)){scoreOverall+=0.2*sleeveScore; hasAny=true;}
      if(!hasAny) return;
      scoreOverall += 0.01*Math.pow(i - table.length/2,2);

      if(scoreOverall<bestOverall.score){bestOverall={idx:i,score:scoreOverall};}
      if(!Number.isNaN(chestScore) && chestScore<bestChest.score){bestChest={idx:i,score:chestScore};}
    });

    return {
      overall: bestOverall.idx>=0 ? bestOverall : null,
      chest: bestChest.idx>=0 ? bestChest : null,
    };
  }

  function renderMeasureResult(len, chest, sleeve, table, selector, whoLabel){
    const err = $("err"), out = $("result");

    if (Number.isNaN(len) || Number.isNaN(chest)) {
      err.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß D√†i √°o v√† Ngang ng·ª±c.";
      err.style.display = "block";
      out.style.display = "none";
      return false;
    }

    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall){
      err.textContent = "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size.";
      err.style.display = "block";
      out.style.display = "none";
      return false;
    }

    const overallIdx = sugg.overall.idx;
    const chestIdx   = sugg.chest?.idx ?? null;

    clearHighlight();
    const tb = document.querySelector(selector);
    if(tb && tb.children[overallIdx]) tb.children[overallIdx].classList.add("pick");

    const pOverall = table[overallIdx];
    const pChest   = chestIdx!=null ? table[chestIdx] : null;

    const user = { len, chest, sleeve };

    let cutDelta = null;
    if(pChest && !Number.isNaN(len) && typeof pChest.len==="number"){
      cutDelta = pChest.len - len;
    }

    let cutMainText = "";
    let cutSubText = "";
    if(pChest && cutDelta !== null){
      if(Math.abs(cutDelta) <= 1){
        cutMainText = "Kh√¥ng c·∫ßn c·∫Øt/tƒÉng lai";
        cutSubText = "D√†i √°o size tu·ª≥ ch·ªânh g·∫ßn gi·ªëng √°o m·∫´u.";
      } else if(cutDelta > 1){
        cutMainText = `C·∫Øt lai ${cutDelta.toFixed(1)}cm`;
        cutSubText = `√Åo chu·∫©n size ${pChest.code} d√†i h∆°n √°o m·∫´u, c·∫Øt b·ªõt ƒë·ªÉ ra ƒë·ªô d√†i t∆∞∆°ng ƒë∆∞∆°ng.`;
      } else {
        cutMainText = `TƒÉng lai ~${Math.abs(cutDelta).toFixed(1)}cm`;
        cutSubText = `Size ${pChest.code} ng·∫Øn h∆°n √°o m·∫´u, c·∫ßn may d√†i h∆°n/tƒÉng lai n·∫øu mu·ªën gi·ªëng √°o m·∫´u.`;
      }
    }

    const rowOverall = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size ƒë·ªÅ xu·∫•t: <span class="size-badge">${pOverall.code}</span></div>
          <div class="hint score">
            ƒêi·ªÉm kh·ªõp t·ªïng th·ªÉ (d√†i √°o + ngang ng·ª±c + tay): <b>${sugg.overall.score.toFixed(1)}</b> (c√†ng th·∫•p c√†ng t·ªët)
          </div>
        </div>
      </div>
    `;

    const rowChestCut = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">2</span> <b>Size tu·ª≥ ch·ªânh</b>
        </div>
        <div class="sugg-body">
          ${
            pChest
            ? `
              <div>Size tu·ª≥ ch·ªânh: <span class="size-badge">${pChest.code}</span></div>
              ${
                cutMainText
                  ? `<div class="cut-main">${cutMainText}</div>
                     <div class="cut-sub">${cutSubText}</div>`
                  : `<div class="hint">C·∫ßn nh·∫≠p d√†i √°o ƒë·ªÉ g·ª£i √Ω c·∫Øt/tƒÉng lai.</div>`
              }
            `
            : "C·∫ßn c√≥ s·ªë ƒëo ngang ng·ª±c (v√† t·ªët nh·∫•t c√≥ th√™m d√†i √°o) ƒë·ªÉ ƒë∆∞a g·ª£i √Ω Size tu·ª≥ ch·ªânh."
          }
        </div>
      </div>
    `;

    const compareTable = `
      <div class="subtitle" style="margin-top:12px">So s√°nh s·ªë ƒëo √°o (theo Size ƒë·ªÅ xu·∫•t &amp; Size tu·ª≥ ch·ªânh)</div>
      <table style="margin-top:6px;font-size:13px">
        <thead>
          <tr>
            <th></th>
            <th>√Åo kh√°ch ƒëo</th>
            <th>Chu·∫©n size ${pOverall.code}</th>
            <th>${pChest ? "Size " + pChest.code + " tu·ª≥ ch·ªânh" : "Size tu·ª≥ ch·ªânh"}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>D√†i √°o</b></td>
            <td>${Number.isNaN(user.len) ? "‚Äî" : user.len.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.len==="number" ? pOverall.len+"cm" : "‚Äî"}</td>
            <td>
              ${
                pChest && typeof pChest.len==="number"
                ? (() => {
                    const base = pChest.len.toFixed(1)+"cm";
                    if(cutDelta===null || Math.abs(cutDelta)<=1) return base;
                    const adj = -cutDelta;
                    const sign = adj>0 ? "+" : "";
                    return base+`<br><span class="cut-cell">${sign}${adj.toFixed(1)}cm</span>`;
                  })()
                : "‚Äî"
              }
            </td>
          </tr>
          <tr>
            <td><b>Ngang ng·ª±c</b></td>
            <td>${Number.isNaN(user.chest) ? "‚Äî" : user.chest.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.chest==="number" ? pOverall.chest+"cm" : "‚Äî"}</td>
            <td>${pChest && typeof pChest.chest==="number" ? pChest.chest+"cm" : "‚Äî"}</td>
          </tr>
          <tr>
            <td><b>D√†i tay</b></td>
            <td>${Number.isNaN(user.sleeve) ? "‚Äî" : user.sleeve.toFixed(1)+"cm"}</td>
            <td>${typeof pOverall.sleeve==="number" ? pOverall.sleeve+"cm" : "‚Äî"}</td>
            <td>${pChest && typeof pChest.sleeve==="number" ? pChest.sleeve+"cm" : "‚Äî"}</td>
          </tr>
        </tbody>
      </table>
    `;

    err.style.display="none";
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω (${whoLabel}) ‚Äî 2 size + b·∫£ng so s√°nh s·ªë ƒëo.</div>
      <div class="suggestion-grid">
        ${rowOverall}
        ${rowChestCut}
      </div>
      ${compareTable}
    `;
    return true;
  }

  function renderKidsMeasure(len, chest, sleeve){
    // L·∫•y b·∫£ng kids theo sport hi·ªán t·∫°i
    const currentKidsTable = getCurrentData(); 
    
    const err=$("err"), out=$("result");

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      err.textContent="Nh·∫≠p √≠t nh·∫•t 1 trong 3 s·ªë ƒëo √°o c·ªßa b√©.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const sugg = calcSuggestions(len, chest, sleeve, currentKidsTable);
    if(!sugg.overall){
      err.textContent="Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size.";
      err.style.display="block"; out.style.display="none"; return false;
    }

    const overallIdx = sugg.overall.idx;
    const chestIdx   = sugg.chest?.idx ?? null;

    clearHighlight();
    const tb = document.querySelector("#tableBodyKid");
    if(tb && tb.children[overallIdx]) tb.children[overallIdx].classList.add("pick");

    const pOverall = currentKidsTable[overallIdx];
    const pChest   = chestIdx!=null ? currentKidsTable[chestIdx] : null;
    const user = { len, chest, sleeve };

    let cutDelta=null;
    if(pChest && !Number.isNaN(len) && typeof pChest.len==="number"){
      cutDelta = pChest.len - len;
    }
    let cutMainText="", cutSubText="";
    if(pChest && cutDelta!==null){
      if(Math.abs(cutDelta)<=1){
        cutMainText="Kh√¥ng c·∫ßn c·∫Øt/tƒÉng lai";
        cutSubText="D√†i √°o size tu·ª≥ ch·ªânh g·∫ßn gi·ªëng √°o b√© ƒëang m·∫∑c.";
      } else if(cutDelta>1){
        cutMainText=`C·∫Øt lai ${cutDelta.toFixed(1)}cm`;
        cutSubText=`√Åo chu·∫©n size ${pChest.code} d√†i h∆°n √°o m·∫´u, c√≥ th·ªÉ c·∫Øt b·ªõt cho b√©.`;
      } else {
        cutMainText=`TƒÉng lai ~${Math.abs(cutDelta).toFixed(1)}cm`;
        cutSubText=`Size ${pChest.code} ng·∫Øn h∆°n √°o m·∫´u, c·∫ßn may d√†i h∆°n n·∫øu ph·ª• huynh mu·ªën gi·ªØ ƒë·ªô d√†i.`;
      }
    }

    const rowOverall = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size ƒë·ªÅ xu·∫•t: <span class="size-badge">${pOverall.code}</span></div>
          <div class="hint score">ƒêi·ªÉm kh·ªõp t·ªïng th·ªÉ: <b>${sugg.overall.score.toFixed(1)}</b></div>
        </div>
      </div>
    `;
    const rowChestCut = `
      <div class="sugg-card">
        <div class="sugg-title">
          <span class="label">2</span> <b>Size tu·ª≥ ch·ªânh</b></div>
        <div class="sugg-body">
          ${
            pChest
            ? `
              <div>Size tu·ª≥ ch·ªânh: <span class="size-badge">${pChest.code}</span></div>
              ${
                cutMainText
                  ? `<div class="cut-main">${cutMainText}</div>
                     <div class="cut-sub">${cutSubText}</div>`
                  : `<div class="hint">C·∫ßn nh·∫≠p d√†i √°o ƒë·ªÉ g·ª£i √Ω c·∫Øt/tƒÉng lai.</div>`
              }
            `
            : "C·∫ßn c√≥ s·ªë ƒëo ngang ng·ª±c (v√† t·ªët nh·∫•t c√≥ th√™m d√†i √°o) ƒë·ªÉ g·ª£i √Ω Size tu·ª≥ ch·ªânh."
          }
        </div>
      </div>
    `;
    const compareTable = `
      <div class="subtitle" style="margin-top:12px">So s√°nh s·ªë ƒëo √°o (theo Size ƒë·ªÅ xu·∫•t &amp; Size tu·ª≥ ch·ªânh)</div>
      <table style="margin-top:6px;font-size:13px">
        <thead>
          <tr>
            <th></th>
            <th>√Åo kh√°ch ƒëo</th>
            <th>Chu·∫©n size ${pOverall.code}</th>
            <th>${pChest ? "Size " + pChest.code + " tu·ª≥ ch·ªânh" : "Size tu·ª≥ ch·ªânh"}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><b>D√†i √°o</b></td>
            <td>${Number.isNaN(user.len) ? "‚Äî" : user.len.toFixed(1)+"cm"}</td>
            <td>${pOverall.len}cm</td>
            <td>
              ${
                pChest
                ? (() => {
                    const base = pChest.len.toFixed(1)+"cm";
                    if(cutDelta===null || Math.abs(cutDelta)<=1) return base;
                    const adj = -cutDelta;
                    const sign = adj>0 ? "+" : "";
                    return base+`<br><span class="cut-cell">${sign}${adj.toFixed(1)}cm</span>`;
                  })()
                : "‚Äî"
              }
            </td>
          </tr>
          <tr>
            <td><b>Ngang ng·ª±c</b></td>
            <td>${Number.isNaN(user.chest) ? "‚Äî" : user.chest.toFixed(1)+"cm"}</td>
            <td>${pOverall.chest}cm</td>
            <td>${pChest ? pChest.chest+"cm" : "‚Äî"}</td>
          </tr>
          <tr>
            <td><b>D√†i tay</b></td>
            <td>${Number.isNaN(user.sleeve) ? "‚Äî" : user.sleeve.toFixed(1)+"cm"}</td>
            <td>${pOverall.sleeve}cm</td>
            <td>${pChest ? pChest.sleeve+"cm" : "‚Äî"}</td>
          </tr>
        </tbody>
      </table>
    `;

    err.style.display="none";
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω (Tr·∫ª em) ‚Äî 2 size + b·∫£ng so s√°nh s·ªë ƒëo.</div>
      <div class="suggestion-grid">
        ${rowOverall}
        ${rowChestCut}
      </div>
      ${compareTable}
    `;
    return true;
  }

  function suggestByMeasure(){
    const g = $("gender").value;
    const sport = $("sport").value;
    const len = parseNum($("len").value);
    const chest = parseNum($("chest").value);
    const sleeve = parseNum($("sleeve").value);

    // L·∫•y b·∫£ng data hi·ªán t·∫°i
    const table = getCurrentData();

    if(g==="kids"){
      return renderKidsMeasure(len, chest, sleeve);
    } 
    
    // N·∫øu l√† B√≥ng ch√†y, lu√¥n d√πng b·∫£ng Unisex (hi·ªÉn th·ªã ·ªü v·ªã tr√≠ b·∫£ng Male)
    if(sport === 'baseball') {
        return renderMeasureResult(len, chest, sleeve, table, "#tableBodyMale", "Unisex/B√≥ng ch√†y");
    }

    if(g==="male"){
      return renderMeasureResult(len, chest, sleeve, table, "#tableBodyMale", "Nam");
    } else {
      return renderMeasureResult(len, chest, sleeve, table, "#tableBodyFemale", "N·ªØ");
    }
  }

  
  function inRange(v,[a,b]){ return v>=a && v<=b; }
  function distToRange(v,[a,b]){ if(v<a) return a-v; if(v>b) return v-b; return 0; }
  function width(range){ const [a,b]=range; return Math.max(1e-9, b-a); }

  function findNearestByRange(value, table, key, direction='max'){
    let bestIdx=-1, bestDist=Infinity;
    table.forEach((s,i)=>{
      const d = distToRange(value, s[key]);
      if (d < bestDist) {
        bestDist = d;
        bestIdx = i;
      } else if (d === bestDist) {
        if (direction === 'max') {
           bestIdx = i; 
        } 
      }
    });
    return bestIdx;
  }

  function calculateBMI(w, h_cm) {
    let h_m = h_cm / 100;
    return w / (h_m * h_m);
  }

  function getBMICategory(bmi) {
    if (bmi < 19) return 'skinny';
    if (bmi <= 24) return 'standard';
    return 'heavy';
  }

  function solveSizeAdult(h, w, table) {
    const bmi = calculateBMI(w, h);
    const shape = getBMICategory(bmi);
    
    let idxH = findNearestByRange(h, table, 'h', 'min');
    let idxW = findNearestByRange(w, table, 'w', 'max');
    
    let finalIdx = -1;
    let logicExplain = "";
    let shapeLabel = "";

    if (shape === 'skinny') {
       shapeLabel = "D√°ng g·∫ßy / cao g·∫ßy (BMI < 19)";
       finalIdx = idxH;
       
       let sizeH = table[idxH];
       let minW = sizeH.w[0];
       if (w < minW - 3) {
          let newIdx = Math.max(0, idxH - 1);
          if (newIdx !== idxH) {
             finalIdx = newIdx;
             logicExplain = `∆Øu ti√™n chi·ªÅu cao (Size ${sizeH.code}), nh∆∞ng do c√¢n n·∫∑ng th·∫•p h∆°n chu·∫©n > 3kg n√™n l√πi 1 size ƒë·ªÉ v·ª´a v·∫∑n h∆°n.`;
          } else {
             logicExplain = `Ch·ªçn theo chi·ªÅu cao.`;
          }
       } else {
          logicExplain = `Ch·ªçn theo chi·ªÅu cao.`;
       }

    } else if (shape === 'standard') {
       shapeLabel = "D√°ng chu·∫©n (BMI 19-24)";
       finalIdx = idxH;
       
       let sizeH = table[idxH];
       let maxW = sizeH.w[1];
       
       if (w > maxW) {
          let newIdx = Math.min(table.length - 1, idxH + 1);
          finalIdx = newIdx;
          logicExplain = `Theo chi·ªÅu cao l√† size ${sizeH.code}, nh∆∞ng c√¢n n·∫∑ng v∆∞·ª£t m·ª©c t·ªëi ƒëa n√™n tƒÉng 1 size.`;
       } else {
          logicExplain = `C√¢n ƒë·ªëi, ch·ªçn size theo chi·ªÅu cao.`;
       }

    } else {
       shapeLabel = "D√°ng ƒë·∫≠m / m·∫≠p (BMI > 24)";
       finalIdx = idxW;
       
       let sizeW = table[idxW];
       let maxW = sizeW.w[1];
       
       if (w >= maxW) {
          let newIdx = Math.min(table.length - 1, idxW + 1);
          if (newIdx !== idxW) {
             finalIdx = newIdx;
             logicExplain = `Ch·ªçn theo c√¢n n·∫∑ng (Size ${sizeW.code}), nh∆∞ng do ch·∫°m ng∆∞·ª°ng t·ªëi ƒëa n√™n tƒÉng 1 size cho tho·∫£i m√°i.`;
          } else {
             logicExplain = `Ch·ªçn theo c√¢n n·∫∑ng (Size l·ªõn nh·∫•t).`;
          }
       } else {
          logicExplain = `∆Øu ti√™n ch·ªçn size theo c√¢n n·∫∑ng ƒë·ªÉ m·∫∑c v·ª´a.`;
       }
    }
    
    return { idx: finalIdx, idxHeightStandard: idxH, shape, shapeLabel, logicExplain, bmi };
  }

  function renderBodyResultAdult(h, w, table, selector, whoLabel){
    const err=$("err"), out=$("result");

    const result = solveSizeAdult(h, w, table);
    const { idx, idxHeightStandard, shapeLabel, logicExplain, bmi } = result;

    if (idx < 0) {
       err.textContent = "Kh√¥ng t√¨m th·∫•y size ph√π h·ª£p trong b·∫£ng.";
       err.style.display="block"; out.style.display="none"; return false;
    }

    const sizeChosen = table[idx]; 
    
    let targetLenIndex = idxHeightStandard; 
    const gap = idxHeightStandard - idx; 
    
    if (Math.abs(gap) > 2) {
        targetLenIndex = Math.round((idx + idxHeightStandard) / 2);
    }
    
    const sizeTargetLen = table[targetLenIndex]; 

    let cutText = "";
    let cutExplain = "";
    
    if(typeof sizeChosen.len === "number" && typeof sizeTargetLen.len === "number"){
        const delta = sizeTargetLen.len - sizeChosen.len; 
        
        if(Math.abs(delta) <= 1){
            cutText = "Gi·ªØ nguy√™n";
            cutExplain = "Chi·ªÅu d√†i √°o t∆∞∆°ng ƒë·ªëi ph√π h·ª£p.";
        } else if(delta > 0){
            cutText = `May th√™m ~${delta.toFixed(1)}cm`;
            cutExplain = `Size ${sizeChosen.code} ng·∫Øn h∆°n so v·ªõi chi·ªÅu cao ${h}cm.`;
        } else {
            cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
            if (Math.abs(gap) > 2) {
                cutExplain = `Do ch√™nh l·ªách l·ªõn, n√™n c·∫Øt v·ªÅ chi·ªÅu d√†i c·ªßa size trung gian ${sizeTargetLen.code} ƒë·ªÉ gi·ªØ d√°ng √°o.`;
            } else {
                cutExplain = `Size ${sizeChosen.code} d√†i h∆°n so v·ªõi chi·ªÅu cao ${h}cm.`;
            }
        }
    } else {
        cutText = "Gi·ªØ nguy√™n";
        cutExplain = "Kh√¥ng ƒë·ªß d·ªØ li·ªáu chi·ªÅu d√†i ƒë·ªÉ t√≠nh to√°n.";
    }

    let note = "";
    if(["XS", "5XL", "6XL", "7XL", "8XL"].includes(sizeChosen.code)) {
       note = `<br><b style="color:#dc2626;">‚ö†Ô∏è L∆∞u √Ω: Size ${sizeChosen.code} vui l√≤ng li√™n h·ªá ƒë·ªÉ check l·∫°i th√¥ng s·ªë √°o ch√≠nh x√°c nh·∫•t.</b>`;
    }

    clearHighlight();
    const tb = document.querySelector(selector);
    if(tb){
      if(tb.children[idx]) tb.children[idx].classList.add("pick");
    }

    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω theo <b>chi·ªÅu cao &amp; c√¢n n·∫∑ng</b> (${whoLabel}).</div>
      <div class="suggestion-grid">
        <div class="sugg-card">
            <div class="sugg-title">
            <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
            </div>
            <div class="sugg-body">
            <div>Size ƒë·ªÅ xu·∫•t: <span class="size-badge">${sizeChosen.code}</span></div>
            <div class="hint score">
                Ph√¢n lo·∫°i: <b>${shapeLabel}</b><br>
                BMI: ${bmi.toFixed(1)}
            </div>
            <div class="hint" style="margin-top:4px; font-style: italic;">
               "${logicExplain}"
            </div>
            </div>
        </div>

        <div class="sugg-card">
            <div class="sugg-title">
            <span class="label">2</span> <b>Size tu·ª≥ ch·ªânh</b>
            </div>
            <div class="sugg-body">
            <div>Size tu·ª≥ ch·ªânh: <span class="size-badge">${sizeChosen.code}</span></div>
            <div class="cut-main">${cutText}</div>
            <div class="cut-sub">${cutExplain}</div>
            </div>
        </div>
      </div>
      <div class="hint" style="margin-top:8px; text-align:center;">${note}</div>
    `;
    return {ok:true, pickIdx: idx, cutText};
  }

  function renderKidsBody(w){
    // L·∫•y b·∫£ng kids hi·ªán t·∫°i
    const table = getCurrentData();

    const err=$("err"), out=$("result");
    const idx = findNearestByRange(w, table, 'w', 'max'); 
    if(idx===-1){
      err.textContent="C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em.";
      err.style.display="block"; out.style.display="none"; return false;
    }
    clearHighlight();
    const tb = document.querySelector("#tableBodyKid");
    if(tb && tb.children[idx]) tb.children[idx].classList.add("pick");
    const p = table[idx];
    out.style.display="block";
    out.innerHTML = `
      <div class="hint">K·∫øt qu·∫£ g·ª£i √Ω theo <b>c√¢n n·∫∑ng</b> (Tr·∫ª em)</div>
      <div class="sugg-card" style="margin-top:8px">
        <div class="sugg-title">
          <span class="label">1</span> <b>Size ƒë·ªÅ xu·∫•t</b>
        </div>
        <div class="sugg-body">
          <div>Size g·ª£i √Ω: <span class="size-badge">${p.code}</span></div>
          <div class="hint" style="margin-top:6px">
            Kho·∫£ng c√¢n n·∫∑ng: <b>${p.w[0]}‚Äì${p.w[1]}kg</b> ‚Ä¢ Tu·ªïi tham kh·∫£o: <b>${p.age}</b>
          </div>
        </div>
      </div>
    `;
    return {ok:true, idx};
  }

  function suggestByBody(){
    const err=$("err"), out=$("result");
    err.style.display="none"; err.textContent=""; out.style.display="none";

    const h=parseNum($("height").value);
    const w=parseNum($("weight").value);
    const g=$("gender").value;
    const sport=$("sport").value;
    const table = getCurrentData();

    if(g==="kids"){
      if(Number.isNaN(w)){
        err.textContent="Nh·∫≠p c√¢n n·∫∑ng cho tr·∫ª em.";
        err.style.display="block"; return false;
      }
      return !!renderKidsBody(w);
    } else {
      if(Number.isNaN(h) || Number.isNaN(w)){
        err.textContent="Nh·∫≠p ƒë·ªß chi·ªÅu cao v√† c√¢n n·∫∑ng.";
        err.style.display="block"; return false;
      }

      if(sport === 'baseball') {
         // Baseball d√πng chung b·∫£ng Male cho t·∫•t c·∫£
         return !!renderBodyResultAdult(h,w,table,"#tableBodyMale","Unisex/B√≥ng ch√†y");
      }

      if(g==="male"){
        return !!renderBodyResultAdult(h,w,table,"#tableBodyMale","Nam");
      } else {
        return !!renderBodyResultAdult(h,w,table,"#tableBodyFemale","N·ªØ");
      }
    }
  }

  
  let teamRows = [];
  let nextRowId = 1;

  function currentTable(){
     // Wrapper cho getCurrentData ƒë·ªÉ t∆∞∆°ng th√≠ch logic c≈©
     return getCurrentData();
  }

  function computeTeamByMeasure(){
    const g = $("gender").value;
    const sport = $("sport").value;
    const len = parseNum($("len").value);
    const chest = parseNum($("chest").value);
    const sleeve = parseNum($("sleeve").value);
    const table = getCurrentData();

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      return {error:"Nh·∫≠p √≠t nh·∫•t 1 trong 3 s·ªë ƒëo √°o."};
    }
    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall) return {error:"Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size."};

    const idxO = sugg.overall.idx;
    const idxC = sugg.chest?.idx ?? null;
    const sizeO = table[idxO];

    let sizeCustomCode = "";
    let cutText = "";
    if(idxC!=null){
      const sc = table[idxC];
      sizeCustomCode = sc.code;
      if(!Number.isNaN(len) && typeof sc.len==="number"){
        const delta = sc.len - len;
        if(Math.abs(delta)<=1){
          cutText = "Gi·ªØ nguy√™n";
        } else if(delta>1){
          cutText = `C·∫Øt lai ${delta.toFixed(1)}cm`;
        } else {
          cutText = `TƒÉng lai ~${Math.abs(delta).toFixed(1)}cm`;
        }
      }
    }

    return {
      g,
      len,chest,sleeve,
      sizeMain: sizeO.code,
      sizeCustom: sizeCustomCode,
      sizeCustomNote: cutText
    };
  }

  function computeTeamByBody(){
    const g = $("gender").value;
    const h=parseNum($("height").value);
    const w=parseNum($("weight").value);
    const table=getCurrentData();

    if(g==="kids"){
      if(Number.isNaN(w)) return {error:"Nh·∫≠p c√¢n n·∫∑ng cho tr·∫ª em."};
      const idx = findNearestByRange(w, table, 'w', 'max');
      if(idx===-1) return {error:"C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em."};
      const size=table[idx].code;
      return {
        g,height:h,weight:w,
        sizeMain:size,
        sizeCustom:size,
        sizeCustomNote:""
      };
    }

    if(Number.isNaN(h) || Number.isNaN(w)) return {error:"Nh·∫≠p ƒë·ªß chi·ªÅu cao v√† c√¢n n·∫∑ng."};
    
    // √Åp d·ª•ng logic BMI
    const result = solveSizeAdult(h, w, table);
    if (result.idx < 0) return { error: "Ngo√†i ph·∫°m vi b·∫£ng tham chi·∫øu." };
    
    const sizeChosen = table[result.idx];
    
    // T√≠nh to√°n c·∫Øt lai
    let targetLenIndex = result.idxHeightStandard; 
    const gap = result.idxHeightStandard - result.idx;
    
    if (Math.abs(gap) > 2) {
        targetLenIndex = Math.round((result.idx + result.idxHeightStandard) / 2);
    }
    const sizeTargetLen = table[targetLenIndex];
    
    let cutText = "";
    if(typeof sizeChosen.len === "number" && typeof sizeTargetLen.len === "number"){
        const delta = sizeTargetLen.len - sizeChosen.len;
        if(Math.abs(delta) <= 1){
            cutText = "Gi·ªØ nguy√™n";
        } else if(delta > 0){
            cutText = `May th√™m ~${delta.toFixed(1)}cm`;
        } else {
            cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
        }
    } else {
        cutText = "Gi·ªØ nguy√™n";
    }

    let note = cutText;
    if(["XS", "5XL", "6XL", "7XL", "8XL"].includes(sizeChosen.code)) {
        note += " (N√™n check l·∫°i)";
    }

    return {
      g, height: h, weight: w,
      sizeMain: sizeChosen.code,
      sizeCustom: sizeChosen.code,
      sizeCustomNote: note
    };
  }

  function addTeamRow(record){
    // Th√™m sport v√†o record ƒë·ªÉ bi·∫øt d√≤ng n√†y thu·ªôc m√¥n n√†o
    const sport = $("sport").value;
    teamRows.push({id:nextRowId++, sport: sport, ...record});
    renderTeamTable();
  }
  function removeTeamMember(id){
    teamRows = teamRows.filter(r=>r.id!==id);
    renderTeamTable();
  }

  function renderTeamTable(){
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const head = $("teamHead");
    const body = $("teamTableBody");
    body.innerHTML="";

    let headerHtml="";
    if(mode==="measure"){
      headerHtml = `
        <tr>
          <th>#</th>
          <th>T√™n</th>
          <th>M√¥n</th>
          <th>S·ªë √°o</th>
          <th>D√†i √°o</th>
          <th>Ng·ª±c</th>
          <th>Tay</th>
          <th>Size ƒë·ªÅ xu·∫•t</th>
          <th>Size tu·ª≥ ch·ªânh</th>
          <th></th>
        </tr>`;
    } else {
      headerHtml = `
        <tr>
          <th>#</th>
          <th>T√™n</th>
          <th>M√¥n</th>
          <th>S·ªë √°o</th>
          <th>Cao</th>
          <th>N·∫∑ng</th>
          <th>Size ƒë·ªÅ xu·∫•t</th>
          <th>Size tu·ª≥ ch·ªânh</th>
          <th></th>
        </tr>`;
    }
    head.innerHTML = headerHtml;

    const rows = teamRows.filter(r=>r.mode===mode);
    rows.forEach((r,idx)=>{
      const fmt = v => (v==null || Number.isNaN(v)) ? "" : (typeof v==="number" ? v.toFixed(1) : v);
      // Format t√™n m√¥n cho ng·∫Øn g·ªçn
      let sportName = r.sport;
      if(sportName === 'football') sportName = 'B√≥ng ƒë√°';
      else if(sportName === 'baseball') sportName = 'B√≥ng ch√†y';
      
      let tr=document.createElement("tr");
      if(mode==="measure"){
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.name || ""}</td>
          <td><small>${sportName}</small></td>
          <td>${r.number || ""}</td>
          <td>${fmt(r.len)}</td>
          <td>${fmt(r.chest)}</td>
          <td>${fmt(r.sleeve)}</td>
          <td><b>${r.sizeMain || ""}</b></td>
          <td style="text-align:left">
            ${r.sizeCustom ? `<b>${r.sizeCustom}</b>` : ""}${r.sizeCustomNote ? ` (${r.sizeCustomNote})` : ""}
          </td>
          <td><button type="button" class="btn-del" onclick="removeTeamMember(${r.id})">&times;</button></td>
        `;
      } else {
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.name || ""}</td>
          <td><small>${sportName}</small></td>
          <td>${r.number || ""}</td>
          <td>${fmt(r.height)}</td>
          <td>${fmt(r.weight)}</td>
          <td><b>${r.sizeMain || ""}</b></td>
          <td style="text-align:left">
            ${r.sizeCustom ? `<b>${r.sizeCustom}</b>` : ""}${r.sizeCustomNote ? ` (${r.sizeCustomNote})` : ""}
          </td>
          <td><button type="button" class="btn-del" onclick="removeTeamMember(${r.id})">&times;</button></td>
        `;
      }
      body.appendChild(tr);
    });
  }

  function clearTeam(){
    teamRows = [];
    renderTeamTable();
  }

function buildExcelDataForCurrentMode(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const rows = teamRows.filter(r => r.mode === mode);

  if (!rows.length) {
    $("err").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªôi ·ªü ch·∫ø ƒë·ªô n√†y ƒë·ªÉ t·∫£i/chia s·∫ª.";
    $("err").style.display = "block";
    return null;
  }
  $("err").style.display = "none";

  const fmt = v => (v == null || Number.isNaN(v))
    ? ""
    : (typeof v === "number" ? v.toFixed(1) : v);

  let header;
  if (mode === "measure") {
    header = ["#", "T√™n", "M√¥n", "S·ªë √°o", "D√†i √°o", "Ng·ª±c", "Tay", "Size ƒë·ªÅ xu·∫•t", "Size tu·ª≥ ch·ªânh"];
  } else {
    header = ["#", "T√™n", "M√¥n", "S·ªë √°o", "Cao", "N·∫∑ng", "Size ƒë·ªÅ xu·∫•t", "Size tu·ª≥ ch·ªânh"];
  }

  const data = [header];

  rows.forEach((r, idx) => {
    let sportName = r.sport;
    if(sportName === 'football') sportName = 'B√≥ng ƒë√°';
    else if(sportName === 'baseball') sportName = 'B√≥ng ch√†y';

    if (mode === "measure") {
      data.push([
        idx + 1,
        r.name || "",
        sportName || "",
        r.number || "",
        fmt(r.len),
        fmt(r.chest),
        fmt(r.sleeve),
        r.sizeMain || "",
        (r.sizeCustom || "") + (r.sizeCustomNote ? " - " + r.sizeCustomNote : "")
      ]);
    } else {
      data.push([
        idx + 1,
        r.name || "",
        sportName || "",
        r.number || "",
        fmt(r.height),
        fmt(r.weight),
        r.sizeMain || "",
        (r.sizeCustom || "") + (r.sizeCustomNote ? " - " + r.sizeCustomNote : "")
      ]);
    }
  });

  return { mode, data };
}

  
 function downloadCSV(){
  if (typeof XLSX === "undefined") {
    alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX. Kh√¥ng th·ªÉ t·∫°o file Excel.");
    return;
  }

  const built = buildExcelDataForCurrentMode();
  if (!built) return;

  const { mode, data } = built;

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DanhSachSize");

  const fileName = `bang-size-doi-${mode}.xlsx`;

  XLSX.writeFile(wb, fileName);
}

function handleSuggest(){
  const modeRadio = document.querySelector('input[name="mode"]:checked');
  const currentMode = modeRadio ? modeRadio.value : "measure";

  const name   = $("playerName").value.trim() || "C·∫ßu th·ªß " + (teamRows.length + 1);
  const number = $("playerNumber").value.trim();

  const len    = parseNum($("len").value);
  const chest  = parseNum($("chest").value);
  const sleeve = parseNum($("sleeve").value);
  const h      = parseNum($("height").value);
  const w      = parseNum($("weight").value);

  const hasMeasure = (!Number.isNaN(len) && !Number.isNaN(chest));
  
  // Logic Kids body: only needs weight
  let hasBody = (!Number.isNaN(h) && !Number.isNaN(w));
  const g = $("gender").value;
  if(g==="kids") {
      hasBody = !Number.isNaN(w);
  }

  if (!hasMeasure && !hasBody) {
    if(g==="kids") $("err").textContent = "Vui l√≤ng nh·∫≠p: C√¢n n·∫∑ng.";
    else $("err").textContent = "Vui l√≤ng nh·∫≠p: (D√†i √°o + Ngang ng·ª±c) HO·∫∂C (Chi·ªÅu cao + C√¢n n·∫∑ng).";
    
    $("err").style.display = "block";
    $("result").style.display = "none";
    return;
  }

  let finalMode;
  if (hasMeasure && hasBody) {
    finalMode = currentMode; 
  } else if (hasMeasure) {
    finalMode = "measure";
  } else {
    finalMode = "body";
  }

  let rec, ok;

  if (finalMode === "measure") {
    rec = computeTeamByMeasure();
    if (rec.error) {
      $("err").textContent = rec.error;
      $("err").style.display = "block";
      $("result").style.display = "none";
      return;
    }

    ok = suggestByMeasure();
    if (!ok) return;

    $("err").style.display = "none";
    addTeamRow({ mode: "measure", name, number, ...rec });
  } else {
    rec = computeTeamByBody();
    if (rec.error) {
      $("err").textContent = rec.error;
      $("err").style.display = "block";
      $("result").style.display = "none";
      return;
    }

    ok = suggestByBody();
    if (!ok) return;

    $("err").style.display = "none";
    addTeamRow({ mode: "body", name, number, ...rec });
  }
}


  
  function clearAll(){
    ["len","chest","sleeve","weight","height","playerName","playerNumber"].forEach(id=>{
      const el=$(id); if(el) el.value="";
    });
    $("err").style.display="none"; $("err").textContent="";
    $("result").style.display="none"; $("result").innerHTML="";
    clearHighlight();
  }
  
  function parseGenderLabel(label){
    const s = (label || "").toString().trim().toLowerCase();
    if(!s) return $("gender").value || "male";
    if(s.startsWith("n·ªØ") || s.startsWith("nu")) return "female";
    if(s.startsWith("tr")) return "kids";
    return "male";
  }

  function downloadExcelTemplate(){
    if(typeof XLSX === "undefined"){
      alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX.");
      return;
    }

    const mode = document.querySelector('input[name="mode"]:checked').value;
    let data, fileName;

    if(mode === "measure"){
      data = [
        ["T√™n", "S·ªë √°o", "ƒê·ªëi t∆∞·ª£ng", "D√†i √°o", "Ng·ª±c", "Tay"],
        ["V√≠ d·ª•: Nam 1", 10, "Nam / N·ªØ / Tr·∫ª em", 70, 52, 22]
      ];
      fileName = "Mau_nhap_thong_so_ao.xlsx";
    } else {
      data = [
        ["T√™n", "S·ªë √°o", "ƒê·ªëi t∆∞·ª£ng", "Chi·ªÅu cao", "C√¢n n·∫∑ng"],
        ["V√≠ d·ª•: Nam 1", 10, "Nam / N·ªØ", 172, 68]
      ];
      fileName = "Mau_nhap_cao_can_nang.xlsx";
    }

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Nhap size");
    XLSX.writeFile(wb, fileName);
  }

  function computeByMeasureFor(g, len, chest, sleeve){
    // L·∫•y table hi·ªán t·∫°i d·ª±a tr√™n sport ƒëang ch·ªçn ·ªü UI
    // L∆∞u √Ω: Khi import excel, ta ƒëang gi·∫£ ƒë·ªãnh user mu·ªën d√πng b·∫£ng size c·ªßa m√¥n ƒëang ch·ªçn tr√™n m√†n h√¨nh
    const table = getCurrentData();

    if(Number.isNaN(len) && Number.isNaN(chest) && Number.isNaN(sleeve)){
      return { error: "Thi·∫øu 3 s·ªë ƒëo √°o." };
    }

    const sugg = calcSuggestions(len, chest, sleeve, table);
    if(!sugg.overall) return { error: "Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ª£i √Ω size." };

    const idxO = sugg.overall.idx;
    const idxC = sugg.chest?.idx ?? null;
    const sizeO = table[idxO];

    let sizeCustomCode = "";
    let cutText = "";
    if(idxC != null){
      const sc = table[idxC];
      sizeCustomCode = sc.code;
      if(!Number.isNaN(len) && typeof sc.len === "number"){
        const delta = sc.len - len;
        if(Math.abs(delta) <= 1){
          cutText = "Gi·ªØ nguy√™n";
        } else if(delta > 0){
          cutText = `TƒÉng lai ~${delta.toFixed(1)}cm`;
        } else {
          cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
        }
      }
    }

    return {
      g,
      len, chest, sleeve,
      sizeMain: sizeO.code,
      sizeCustom: sizeCustomCode,
      sizeCustomNote: cutText
    };
  }

  function computeByBodyFor(g, h, w){
    const table = getCurrentData();

    if(g === "kids"){
      if(Number.isNaN(w)) return { error: "Thi·∫øu c√¢n n·∫∑ng tr·∫ª em." };
      const idx = table.findIndex(s => inRange(w, s.w));
      if(idx === -1) return { error: "C√¢n n·∫∑ng n·∫±m ngo√†i b·∫£ng tr·∫ª em." };
      const size = table[idx].code;
      return {
        g, height: h, weight: w,
        sizeMain: size,
        sizeCustom: size,
        sizeCustomNote: ""
      };
    }

    if(Number.isNaN(h) || Number.isNaN(w)){
      return { error: "Thi·∫øu chi·ªÅu cao ho·∫∑c c√¢n n·∫∑ng." };
    }

    // √Åp d·ª•ng logic BMI
    const result = solveSizeAdult(h, w, table);
    if (result.idx < 0) return { error: "Ngo√†i ph·∫°m vi b·∫£ng tham chi·∫øu." };
    
    const sizeChosen = table[result.idx];
    
    // T√≠nh to√°n c·∫Øt lai
    let targetLenIndex = result.idxHeightStandard; 
    const gap = result.idxHeightStandard - result.idx;
    
    if (Math.abs(gap) > 2) {
        targetLenIndex = Math.round((result.idx + result.idxHeightStandard) / 2);
    }
    const sizeTargetLen = table[targetLenIndex];
    
    let cutText = "";
    if(typeof sizeChosen.len === "number" && typeof sizeTargetLen.len === "number"){
        const delta = sizeTargetLen.len - sizeChosen.len;
        if(Math.abs(delta) <= 1){
            cutText = "Gi·ªØ nguy√™n";
        } else if(delta > 0){
            cutText = `May th√™m ~${delta.toFixed(1)}cm`;
        } else {
            cutText = `C·∫Øt lai ${Math.abs(delta).toFixed(1)}cm`;
        }
    } else {
        cutText = "Gi·ªØ nguy√™n";
    }

    let note = cutText;
    if(["XS", "5XL", "6XL", "7XL", "8XL"].includes(sizeChosen.code)) {
        note += " (N√™n check l·∫°i)";
    }

    return {
      g, height: h, weight: w,
      sizeMain: sizeChosen.code,
      sizeCustom: sizeChosen.code,
      sizeCustomNote: note
    };
  }

  function handleImportExcel(evt){
    const file = evt.target.files[0];
    if(!file) return;

    if(typeof XLSX === "undefined"){
      alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

      const mode = document.querySelector('input[name="mode"]:checked').value;
      let added = 0;

      json.forEach(row => {
        const name = (row["T√™n"] || row["Ten"] || row["Name"] || "").toString().trim();
        const number = (row["S·ªë √°o"] || row["So ao"] || row["So"] || row["Number"] || "").toString().trim();
        const genderLabel = row["ƒê·ªëi t∆∞·ª£ng"] || row["Doi tuong"] || row["Gender"] || "";
        const g = parseGenderLabel(genderLabel);

        if(mode === "measure"){
          const len   = parseNum(row["D√†i √°o"] || row["Dai ao"] || "");
          const chest = parseNum(row["Ng·ª±c"]   || row["Nguc"]   || "");
          const sleeve= parseNum(row["Tay"]    || "");

          const rec = computeByMeasureFor(g, len, chest, sleeve);
          if(rec.error) return;

          addTeamRow({
            mode: "measure",
            name: name || ("C·∫ßu th·ªß " + (teamRows.length + 1)),
            number,
            ...rec
          });
          added++;
        } else {
          const h = parseNum(row["Chi·ªÅu cao"] || row["Chieu cao"] || row["Cao"] || "");
          const w = parseNum(row["C√¢n n·∫∑ng"]  || row["Can nang"]  || row["N·∫∑ng"] || "");

          const rec = computeByBodyFor(g, h, w);
          if(rec.error) return;

          addTeamRow({
            mode: "body",
            name: name || ("C·∫ßu th·ªß " + (teamRows.length + 1)),
            number,
            ...rec
          });
          added++;
        }
      });

      if(!added){
        alert("Kh√¥ng c√≥ d√≤ng h·ª£p l·ªá trong file Excel (ki·ªÉm tra t√™n c·ªôt & d·ªØ li·ªáu).");
      } else {
        $("err").style.display = "none";
      }

      evt.target.value = "";
    };

    reader.readAsArrayBuffer(file);
  }

  
  ["len","chest","sleeve","weight","height"].forEach(id=>{
    const el=$(id); if(!el) return;
    el.addEventListener("keydown",e=>{
      if(e.key==="Enter"){ e.preventDefault(); handleSuggest(); }
    });
  });
lucide.createIcons();

async function shareExcel() {

  const ua = navigator.userAgent || "";
  const isIOS = /iPhone|iPad|iPod/i.test(ua);


  if (!isIOS || !navigator.share) {
    showShareGuide();
    return;
  }

  if (typeof XLSX === "undefined") {
    alert("Kh√¥ng t√¨m th·∫•y th∆∞ vi·ªán XLSX. Kh√¥ng th·ªÉ t·∫°o file ƒë·ªÉ chia s·∫ª.");
    return;
  }

  const built = buildExcelDataForCurrentMode();
  if (!built) return;

  const { mode, data } = built;

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "DanhSachSize");

  const fileName = `danhsach-size-doi-${mode}.xlsx`;
  const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });

  const blob = new Blob(
    [wbout],
    { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }
  );
  const file = new File([blob], fileName, { type: blob.type });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({
        title: "Danh s√°ch size ƒë·ªôi",
        text: "File Excel danh s√°ch size t·ª´ c√¥ng c·ª•.",
        files: [file],
      });
      return;
    } catch (e) {
      console.log("User canceled share:", e);

      return;
    }
  }

  showShareGuide();
}

function openGuide(){
  $("excelGuidePopup").style.display = "flex";
}
function closeGuide(){
  $("excelGuidePopup").style.display = "none";
}
function showShareGuide(){
  document.getElementById("shareGuidePopup").style.display = "flex";
}

function closeShareGuide(){
  document.getElementById("shareGuidePopup").style.display = "none";
}

window.addEventListener("DOMContentLoaded", function () {
  const shareBtn = document.getElementById("shareButton");
  if (!shareBtn) return;

  shareBtn.classList.remove("hidden");
});

// Init trigger ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng b·∫£ng ban ƒë·∫ßu
handleSportChange();

</script>
</body>
</html>